<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hierarchical aggregation via model specification — model_aggregate • SSBtools</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical aggregation via model specification — model_aggregate"><meta name="description" content="Internally a dummy/model matrix is created according to the model specification.
This model matrix is used in the aggregation process via matrix multiplication and/or the function aggregate_multiple_fun."><meta property="og:description" content="Internally a dummy/model matrix is created according to the model specification.
This model matrix is used in the aggregation process via matrix multiplication and/or the function aggregate_multiple_fun."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SSBtools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.6.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/statisticsnorway/ssb-ssbtools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Hierarchical aggregation via model specification</h1>
      <small class="dont-index">Source: <a href="https://github.com/statisticsnorway/ssb-ssbtools/blob/master/R/model_aggregate.R" class="external-link"><code>R/model_aggregate.R</code></a></small>
      <div class="d-none name"><code>model_aggregate.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Internally a dummy/model matrix is created according to the model specification.
This model matrix is used in the aggregation process via matrix multiplication and/or the function <code><a href="aggregate_multiple_fun.html">aggregate_multiple_fun</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">model_aggregate</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  sum_vars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fun_vars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fun <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  hierarchies <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dim_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  total <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  input_in_output <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  remove_empty <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  avoid_hierarchical <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  preagg_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dummy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pre_aggregate <span class="op">=</span> <span class="va">dummy</span>,</span>
<span>  aggregate_pkg <span class="op">=</span> <span class="st">"base"</span>,</span>
<span>  aggregate_na <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  aggregate_base_order <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  list_return <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  pre_return <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  mm_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Input data containing data to be aggregated, typically a data frame, tibble, or data.table.
If data is not a classic data frame, it will be coerced to one internally.</p></dd>


<dt id="arg-sum-vars">sum_vars<a class="anchor" aria-label="anchor" href="#arg-sum-vars"></a></dt>
<dd><p>Variables to be summed. This will be done via matrix multiplication.</p></dd>


<dt id="arg-fun-vars">fun_vars<a class="anchor" aria-label="anchor" href="#arg-fun-vars"></a></dt>
<dd><p>Variables to be aggregated by supplied functions.
This will be done via <code><a href="aggregate_multiple_fun.html">aggregate_multiple_fun</a></code> and <code><a href="dummy_aggregate.html">dummy_aggregate</a></code> and
<code>fun_vars</code> is specified as the parameter <code>vars</code>.</p></dd>


<dt id="arg-fun">fun<a class="anchor" aria-label="anchor" href="#arg-fun"></a></dt>
<dd><p>The <code>fun</code>         parameter to <code><a href="aggregate_multiple_fun.html">aggregate_multiple_fun</a></code></p></dd>


<dt id="arg-hierarchies">hierarchies<a class="anchor" aria-label="anchor" href="#arg-hierarchies"></a></dt>
<dd><p>The <code>hierarchies</code> parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code></p></dd>


<dt id="arg-formula">formula<a class="anchor" aria-label="anchor" href="#arg-formula"></a></dt>
<dd><p>The <code>formula</code>     parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code></p></dd>


<dt id="arg-dim-var">dim_var<a class="anchor" aria-label="anchor" href="#arg-dim-var"></a></dt>
<dd><p>The <code>dimVar</code>      parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code></p></dd>


<dt id="arg-total">total<a class="anchor" aria-label="anchor" href="#arg-total"></a></dt>
<dd><p>When non-NULL, the <code>total</code> parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code>.
Thus, the actual default value is <code>"Total"</code>.</p></dd>


<dt id="arg-input-in-output">input_in_output<a class="anchor" aria-label="anchor" href="#arg-input-in-output"></a></dt>
<dd><p>When non-NULL, the <code>inputInOutput</code> parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code>.
Thus, the actual default value is <code>TRUE</code>.</p></dd>


<dt id="arg-remove-empty">remove_empty<a class="anchor" aria-label="anchor" href="#arg-remove-empty"></a></dt>
<dd><p>When non-NULL, the <code>removeEmpty</code> parameter to <code><a href="ModelMatrix.html">ModelMatrix</a></code>.
Thus, the actual default value is <code>TRUE</code> with formula input without hierarchy and
otherwise <code>FALSE</code> (see <code><a href="ModelMatrix.html">ModelMatrix</a></code>).</p></dd>


<dt id="arg-avoid-hierarchical">avoid_hierarchical<a class="anchor" aria-label="anchor" href="#arg-avoid-hierarchical"></a></dt>
<dd><p>When non-NULL, the <code>avoidHierarchical</code> parameter to <code><a href="FormulaSums.html">Formula2ModelMatrix</a></code>,
which is an underlying function of <code><a href="ModelMatrix.html">ModelMatrix</a></code>.</p></dd>


<dt id="arg-preagg-var">preagg_var<a class="anchor" aria-label="anchor" href="#arg-preagg-var"></a></dt>
<dd><p>Extra variables to be used as grouping elements in the pre-aggregate step</p></dd>


<dt id="arg-dummy">dummy<a class="anchor" aria-label="anchor" href="#arg-dummy"></a></dt>
<dd><p>The <code>dummy</code>       parameter to <code><a href="dummy_aggregate.html">dummy_aggregate</a></code>.
When <code>TRUE</code>, only 0s and 1s are assumed in the generated model matrix.
When <code>FALSE</code>, non-0s in this matrix are passed as an additional first input parameter to the <code>fun</code> functions.</p></dd>


<dt id="arg-pre-aggregate">pre_aggregate<a class="anchor" aria-label="anchor" href="#arg-pre-aggregate"></a></dt>
<dd><p>Whether to pre-aggregate data to reduce the dimension of the model matrix.
Note that all original <code>fun_vars</code> observations are retained in the aggregated dataset and <code>pre_aggregate</code> does not affect the final result.
However, <code>pre_aggregate</code> must be set to <code>FALSE</code> when the <code>dummy_aggregate</code> parameter <code>dummy</code> is set to <code>FALSE</code>
since then <code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></code> will not be run.
An exception to this is if the <code>fun</code> functions are written to handle list data.</p></dd>


<dt id="arg-aggregate-pkg">aggregate_pkg<a class="anchor" aria-label="anchor" href="#arg-aggregate-pkg"></a></dt>
<dd><p>Package used to pre-aggregate.
Parameter <code>pkg</code> to <code><a href="aggregate_by_pkg.html">aggregate_by_pkg</a></code>.</p></dd>


<dt id="arg-aggregate-na">aggregate_na<a class="anchor" aria-label="anchor" href="#arg-aggregate-na"></a></dt>
<dd><p>Whether to include NAs in the grouping variables while preAggregate.
Parameter <code>include_na</code> to <code><a href="aggregate_by_pkg.html">aggregate_by_pkg</a></code>.</p></dd>


<dt id="arg-aggregate-base-order">aggregate_base_order<a class="anchor" aria-label="anchor" href="#arg-aggregate-base-order"></a></dt>
<dd><p>Parameter <code>base_order</code> to <code><a href="aggregate_by_pkg.html">aggregate_by_pkg</a></code>, used when pre-aggregate.
The default is set to <code>FALSE</code> to avoid unnecessary sorting operations.
When <code>TRUE</code>, an attempt is made to return the same result with <code>data.table</code> as with base R.
This cannot be guaranteed due to potential variations in sorting behavior across different systems.</p></dd>


<dt id="arg-list-return">list_return<a class="anchor" aria-label="anchor" href="#arg-list-return"></a></dt>
<dd><p>Whether to return a list of separate components including the model matrix <code>x</code>.</p></dd>


<dt id="arg-pre-return">pre_return<a class="anchor" aria-label="anchor" href="#arg-pre-return"></a></dt>
<dd><p>Whether to return the pre-aggregate data as a two-component list. Can also be combined with <code>list_return</code> (see examples).</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Whether to print information during calculations.</p></dd>


<dt id="arg-mm-args">mm_args<a class="anchor" aria-label="anchor" href="#arg-mm-args"></a></dt>
<dd><p>List of further arguments passed to <code>ModelMatrix</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Further arguments passed to <code>dummy_aggregate</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data frame or a list.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>With formula input, limited output can be achieved by <code><a href="FormulaSelection.html">formula_selection</a></code> (see example).
An attribute called <code>startCol</code> has been added to the output data frame to make this functionality work.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="SSBtoolsData.html">SSBtoolsData</a></span><span class="op">(</span><span class="st">"sprt_emp_withEU"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">z</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">z</span><span class="op">$</span><span class="va">age</span> <span class="op">==</span> <span class="st">"Y15-29"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"young"</span></span></span>
<span class="r-in"><span><span class="va">z</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">z</span><span class="op">$</span><span class="va">age</span> <span class="op">==</span> <span class="st">"Y30-64"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"old"</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">==</span> <span class="st">"ths_per"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"ths"</span></span></span>
<span class="r-in"><span><span class="va">z</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">18</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">my_range</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, </span></span>
<span class="r-in"><span>   formula <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">:</span><span class="va">year</span> <span class="op">+</span> <span class="va">geo</span>, </span></span>
<span class="r-in"><span>   sum_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"ths"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>   fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="st">"ths"</span>, mean <span class="op">=</span> <span class="st">"y"</span>, med <span class="op">=</span> <span class="st">"y"</span>, ra <span class="op">=</span> <span class="st">"ths"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>   fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="va">sum</span>, mean <span class="op">=</span> <span class="va">mean</span>, med <span class="op">=</span> <span class="va">median</span>, ra <span class="op">=</span> <span class="va">my_range</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;18*7] [ModelMatrix] [crossprod] [dummy_aggregate] [cbind]</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">out</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age  year      geo   y   ths ths_sum y_mean y_med ths_ra.min ths_ra.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1  Total Total    Total 171 680.8   680.8    9.5   9.5        1.5      122.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  Total Total  Iceland  57  10.6    10.6    9.5   9.5        1.5        1.9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3  Total Total Portugal  63 108.8   108.8   10.5  10.5       11.6       25.8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  Total Total    Spain  51 561.4   561.4    8.5   8.5       63.4      122.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    old  2014    Total  15 142.0   142.0    5.0   5.0        1.5      120.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    old  2015    Total  33 145.5   145.5   11.0  11.0        1.6      119.6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    old  2016    Total  51 149.8   149.8   17.0  17.0        1.9      122.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8  young  2014    Total   6  80.3    80.3    2.0   2.0        1.8       66.9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9  young  2015    Total  24  79.5    79.5    8.0   8.0        1.9       63.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10 young  2016    Total  42  83.7    83.7   14.0  14.0        1.9       69.1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Limited output can be achieved by formula_selection</span></span></span>
<span class="r-in"><span><span class="fu"><a href="FormulaSelection.html">formula_selection</a></span><span class="op">(</span><span class="va">out</span>, <span class="op">~</span><span class="va">geo</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age  year      geo   y   ths ths_sum y_mean y_med ths_ra.min ths_ra.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 Total Total    Total 171 680.8   680.8    9.5   9.5        1.5      122.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 Total Total  Iceland  57  10.6    10.6    9.5   9.5        1.5        1.9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 Total Total Portugal  63 108.8   108.8   10.5  10.5       11.6       25.8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 Total Total    Spain  51 561.4   561.4    8.5   8.5       63.4      122.1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Using the single unnamed variable feature.</span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, formula <span class="op">=</span> <span class="op">~</span><span class="va">age</span>, fun_vars <span class="op">=</span> <span class="st">"y"</span>, </span></span>
<span class="r-in"><span>                fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="va">sum</span>, mean <span class="op">=</span> <span class="va">mean</span>, med <span class="op">=</span> <span class="va">median</span>, n <span class="op">=</span> <span class="va">length</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;2*2] [ModelMatrix] [dummy_aggregate] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age sum mean  med  n</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 Total 171  9.5  9.5 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   old  99 11.0 11.0  9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 young  72  8.0  8.0  9</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To illustrate list_return and pre_return </span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">pre_return</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw">for</span> <span class="op">(</span><span class="va">list_return</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=======================================\n"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"list_return ="</span>, <span class="va">list_return</span>, <span class="st">", pre_return ="</span>, <span class="va">pre_return</span>, <span class="st">"\n\n"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, formula <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">:</span><span class="va">year</span>, </span></span>
<span class="r-in"><span>                         sum_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ths"</span>, <span class="st">"y"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                         fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="st">"y"</span>, ra <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                         fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, ra <span class="op">=</span> <span class="va">my_range</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                         list_return <span class="op">=</span> <span class="va">list_return</span>,</span></span>
<span class="r-in"><span>                         pre_return <span class="op">=</span> <span class="va">pre_return</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> =======================================</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> list_return = FALSE , pre_return = FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*5] [ModelMatrix] [crossprod] [dummy_aggregate] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age  year   ths   y y_mean y_ra.min y_ra.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 Total Total 680.8 171    9.5        1       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   old  2014 142.0  15    5.0        4        6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   old  2015 145.5  33   11.0       10       12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   old  2016 149.8  51   17.0       16       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 young  2014  80.3   6    2.0        1        3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 young  2015  79.5  24    8.0        7        9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7 young  2016  83.7  42   14.0       13       15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> =======================================</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> list_return = TRUE , pre_return = FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*5] [ModelMatrix] [crossprod] [dummy_aggregate] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $cross_table</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age  year</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 Total Total</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   old  2014</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   old  2015</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   old  2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 young  2014</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 young  2015</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7 young  2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $sum_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               ths   y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total-Total 680.8 171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2014    142.0  15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2015    145.5  33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2016    149.8  51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2014   80.3   6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2015   79.5  24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2016   83.7  42</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $fun_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   y_mean y_ra.min y_ra.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    9.5        1       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    5.0        4        6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   11.0       10       12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   17.0       16       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    2.0        1        3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    8.0        7        9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7   14.0       13       15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $x</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 x 7 sparse Matrix of class "dgCMatrix"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Total-Total old-2014 old-2015 old-2016 young-2014 young-2015 young-2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]           1        1        .        .          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]           1        .        .        .          1          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]           1        .        1        .          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]           1        .        .        .          .          1          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5,]           1        .        .        1          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [6,]           1        .        .        .          .          .          1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> =======================================</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> list_return = FALSE , pre_return = TRUE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*5] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pre_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age year          y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   old 2014    4, 5, 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 young 2014    1, 2, 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   old 2015 10, 11, 12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 young 2015    7, 8, 9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   old 2016 16, 17, 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 young 2016 13, 14, 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pre_sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ths  y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 142.0 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  80.3  6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 145.5 33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  79.5 24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 149.8 51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6  83.7 42</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> =======================================</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> list_return = TRUE , pre_return = TRUE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*5] [ModelMatrix] [crossprod] [dummy_aggregate] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pre_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age year          y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   old 2014    4, 5, 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 young 2014    1, 2, 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   old 2015 10, 11, 12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 young 2015    7, 8, 9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   old 2016 16, 17, 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 young 2016 13, 14, 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pre_sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ths  y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 142.0 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  80.3  6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 145.5 33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  79.5 24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 149.8 51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6  83.7 42</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $cross_table</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     age  year</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 Total Total</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   old  2014</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   old  2015</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   old  2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 young  2014</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 young  2015</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7 young  2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $sum_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               ths   y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total-Total 680.8 171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2014    142.0  15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2015    145.5  33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> old-2016    149.8  51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2014   80.3   6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2015   79.5  24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> young-2016   83.7  42</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $fun_data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   y_mean y_ra.min y_ra.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    9.5        1       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    5.0        4        6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   11.0       10       12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   17.0       16       18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    2.0        1        3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    8.0        7        9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7   14.0       13       15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $x</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 x 7 sparse Matrix of class "dgCMatrix"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Total-Total old-2014 old-2015 old-2016 young-2014 young-2015 young-2016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]           1        1        .        .          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]           1        .        .        .          1          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]           1        .        1        .          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [4,]           1        .        .        .          .          1          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5,]           1        .        .        1          .          .          .</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [6,]           1        .        .        .          .          .          1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To illustrate preagg_var </span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, formula <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">:</span><span class="va">year</span>, </span></span>
<span class="r-in"><span>sum_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ths"</span>, <span class="st">"y"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="st">"y"</span>, ra <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, ra <span class="op">=</span> <span class="va">my_range</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>preagg_var <span class="op">=</span> <span class="st">"eu"</span>,</span></span>
<span class="r-in"><span>pre_return <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="st">"pre_data"</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;12*6] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age year    eu      y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    old 2014    EU   4, 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  young 2014    EU   1, 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    old 2015    EU 10, 12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  young 2015    EU   7, 9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    old 2016    EU 16, 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6  young 2016    EU 13, 15</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    old 2014 nonEU      5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8  young 2014 nonEU      2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9    old 2015 nonEU     11</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10 young 2015 nonEU      8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11   old 2016 nonEU     17</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12 young 2016 nonEU     14</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To illustrate hierarchies </span></span></span>
<span class="r-in"><span><span class="va">geo_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="SSBtoolsData.html">SSBtoolsData</a></span><span class="op">(</span><span class="st">"sprt_emp_geoHier"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, hierarchies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"All"</span>, geo <span class="op">=</span> <span class="va">geo_hier</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                sum_vars <span class="op">=</span> <span class="st">"y"</span>, </span></span>
<span class="r-in"><span>                fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*4] [ModelMatrix] [crossprod] [dummy_aggregate] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age      geo   y y_sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    All       EU 114   114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    All   Europe 171   171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    All    nonEU  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    All  Iceland  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    All Portugal  63    63</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    All    Spain  51    51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    old       EU  66    66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8    old   Europe  99    99</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9    old    nonEU  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10   old  Iceland  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11   old Portugal  36    36</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12   old    Spain  30    30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13 young       EU  48    48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14 young   Europe  72    72</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15 young    nonEU  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16 young  Iceland  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17 young Portugal  27    27</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18 young    Spain  21    21</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">####  Special non-dummy cases illustrated below  ####</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extend the hierarchy to make non-dummy model matrix  </span></span></span>
<span class="r-in"><span><span class="va">geo_hier2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mapsFrom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EU"</span>, <span class="st">"Spain"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                              mapsTo <span class="op">=</span> <span class="st">"EUandSpain"</span>, sign <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">geo_hier</span><span class="op">[</span>, <span class="op">-</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Warning since non-dummy</span></span></span>
<span class="r-in"><span><span class="co"># y and y_sum are different </span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, hierarchies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"All"</span>, geo <span class="op">=</span> <span class="va">geo_hier2</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                sum_vars <span class="op">=</span> <span class="st">"y"</span>, </span></span>
<span class="r-in"><span>                fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*4] [ModelMatrix] [crossprod] [dummy_aggregate</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>All non-0s in x are treated as 1s. Use dummy = FALSE?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age        geo   y y_sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    All EUandSpain 165   114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    All         EU 114   114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    All     Europe 171   171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    All      nonEU  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    All    Iceland  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    All   Portugal  63    63</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    All      Spain  51    51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8    old EUandSpain  96    66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9    old         EU  66    66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10   old     Europe  99    99</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11   old      nonEU  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12   old    Iceland  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13   old   Portugal  36    36</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14   old      Spain  30    30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15 young EUandSpain  69    48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16 young         EU  48    48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17 young     Europe  72    72</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18 young      nonEU  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 19 young    Iceland  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 young   Portugal  27    27</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 21 young      Spain  21    21</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># No warning since dummy since unionComplement = TRUE (see ?HierarchyCompute)</span></span></span>
<span class="r-in"><span><span class="co"># y and y_sum are equal   </span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, hierarchies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"All"</span>, geo <span class="op">=</span> <span class="va">geo_hier2</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                sum_vars <span class="op">=</span> <span class="st">"y"</span>, </span></span>
<span class="r-in"><span>                fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                mm_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>unionComplement <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [pre_aggregate 18*6-&gt;6*4] [ModelMatrix] [crossprod] [dummy_aggregate] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age        geo   y y_sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    All EUandSpain 114   114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    All         EU 114   114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    All     Europe 171   171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    All      nonEU  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    All    Iceland  57    57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    All   Portugal  63    63</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    All      Spain  51    51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8    old EUandSpain  66    66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9    old         EU  66    66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10   old     Europe  99    99</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11   old      nonEU  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12   old    Iceland  33    33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13   old   Portugal  36    36</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14   old      Spain  30    30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15 young EUandSpain  48    48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16 young         EU  48    48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17 young     Europe  72    72</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18 young      nonEU  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 19 young    Iceland  24    24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 young   Portugal  27    27</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 21 young      Spain  21    21</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Non-dummy again, but no warning since dummy = FALSE</span></span></span>
<span class="r-in"><span><span class="co"># Then pre_aggregate is by default set to FALSE (error when TRUE) </span></span></span>
<span class="r-in"><span><span class="co"># fun with extra argument needed (see ?dummy_aggregate)</span></span></span>
<span class="r-in"><span><span class="co"># y and y_sum2 are equal</span></span></span>
<span class="r-in"><span><span class="fu">model_aggregate</span><span class="op">(</span><span class="va">z</span>, hierarchies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"All"</span>, geo <span class="op">=</span> <span class="va">geo_hier2</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                sum_vars <span class="op">=</span> <span class="st">"y"</span>, </span></span>
<span class="r-in"><span>                fun_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum2 <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sum2 <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                dummy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [ModelMatrix] [crossprod] [dummy_aggregate] [cbind]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      age        geo   y y_sum2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    All EUandSpain 165    165</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    All         EU 114    114</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    All     Europe 171    171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    All      nonEU  57     57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    All    Iceland  57     57</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    All   Portugal  63     63</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7    All      Spain  51     51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8    old EUandSpain  96     96</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9    old         EU  66     66</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10   old     Europe  99     99</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11   old      nonEU  33     33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12   old    Iceland  33     33</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13   old   Portugal  36     36</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14   old      Spain  30     30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15 young EUandSpain  69     69</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16 young         EU  48     48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17 young     Europe  72     72</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18 young      nonEU  24     24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 19 young    Iceland  24     24</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 young   Portugal  27     27</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 21 young      Spain  21     21</span>
<span class="r-in"><span>                </span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Øyvind Langsrud, Daniel Lupp.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

